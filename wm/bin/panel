#!/bin/sh
#
# main lemonbar
#
# wm script

. ~/.config/lemonbar/panel

name=panel; fifo=/tmp/panel

if xdo id -a "$name" > /dev/null; then
    echo "error : panel already running"
    exit 1
fi

# ensure proper script cleanup
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

test -e "$fifo" &&
    rm "$fifo"
mkfifo "$fifo"

# accent color shortcuts
a=%{F$accent}; t=%{F-}

# source all our functions
for i in ~/bin/lemons/*; do
    . "$i"
done

wks > "$fifo" &
clk > "$fifo" &
ntw > "$fifo" &
vol > "$fifo" &
bat > "$fifo" &

while read -r line; do
    case $line in
        W*) wks=${line#?};;
        C*) clk=${line#?};;
        N*) ntw=${line#?};;
        V*) vol=${line#?};;
        B*) bat=${line#?}
    esac

    echo "%{l}  $wks%{c}$clk%{r}$ntw  $vol  $bat  "
done < "$fifo" | \
    lemonbar -g "x$height" \
    -F "$foreground" \
    -B "$background" \
    -f "$font" \
    -f "$icons" \
    -n "$name" &

# ensure proper fullscreen
# NOTE : use xdo -m when available
until xdo id -a "$name" > /dev/null; do
    sleep .1
done
xdo lower -a "$name"

wait
