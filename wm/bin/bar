#!/bin/sh
#
# lemonbar
#
# wm tool

# SETTINGS

a='%{F#FF99A1}'
t='%{F-}'

fifo=/tmp/bar

# FIFO

[ -e "$fifo" ] && rm "$fifo"
mkfifo "$fifo"

wks() {
    bspc subscribe | while read -r line; do
        out=
        var=$(echo "$line" | grep -om1 '[OFU][1-5]' | tail -c2)
        for i in $(seq 1 5); do
            if [ "$var" -eq "$i" ]; then
                out="$out$a$t"
            else
                out="$out"
            fi
        done
        echo "W$out"
    done
}
wks > "$fifo" &

clk() {
    while :; do
        var=$(date +'%a %R')
        echo "C$a$t $var"

        sleep 10s
    done
}
clk > "$fifo" &

ntw() {
    while :; do
        var=$(iwgetid -r)
        echo "N$a$t ${var:-Offline}"

        sleep 1s
    done
}
ntw > "$fifo" &

vol() {
    {
        # run on startup
        echo init
        pactl subscribe 2> /dev/null
    } | \
        while read -r line; do
            case $line in
                init|*\#0)
                    var=$(pactl list sinks)
                    if echo "$var" | grep -q 'Muted: yes'; then
                        out="$a$t Muted"
                    else
                        var=$(echo "$var" | grep -o '[0-9]*%' | head -1)
                        out="$a$t $var"
                    fi
                    echo "V$out"
                    ;;
            esac
        done
}
vol > "$fifo" &

bat() {
    while :; do
        var=$(cat /sys/class/power_supply/BAT0/capacity)
        if [ "$var" -eq 100 ]; then
            out="$a$t $var%"
        elif [ "$var" -gt 75 ]; then
            out="$a$t $var%"
        elif [ "$var" -gt 25 ]; then
            out="$a$t $var%"
        else
            out="$a$t $var%"
        fi
        echo "B$out"

        sleep 10s
    done
}
bat > "$fifo" &

# MAIN

# ensure proper script cleanup
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

while read -r line; do
    case $line in
        W*) wks=${line#?};;
        C*) clk=${line#?};;
        N*) ntw=${line#?};;
        V*) vol=${line#?};;
        B*) bat=${line#?};;
    esac
    echo "%{l}  ${wks}%{c}${clk}%{r}${ntw}  ${vol}  ${bat}  "
done < "$fifo" | lemonbar -g x30 \
    -f "-t-cherry-medium-r-normal--10-100-75-75-c-100-iso8859-1" \
    -f "-wuncon-siji-medium-r-normal--10-100-75-75-c-80-iso10646-1" \
    -B \#021B21 \
    -F \#E8DFD6
