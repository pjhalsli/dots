#!/bin/sh
#
# main lemonbar
#
# wm script

. ~/.config/lemonbar/panel

# source all functions
for i in ~/bin/lemons/*; do
    . "$i"
done

# ensure proper script cleanup
trap 'trap - TERM; kill 0' INT TERM QUIT EXIT

[ -e "$fifo" ] && rm "$fifo"
mkfifo "$fifo"

wks > "$fifo" &
clk > "$fifo" &
ntw > "$fifo" &
vol > "$fifo" &
bat > "$fifo" &

while read -r line; do
    case $line in
        W*) wks=${line#?};;
        C*) clk=${line#?};;
        N*) ntw=${line#?};;
        V*) vol=${line#?};;
        B*) bat=${line#?}
    esac

    echo "%{l}  ${wks}%{c}${clk}%{r}${ntw}  ${vol}  ${bat}  "
done < "$fifo" | \
    lemonbar -g "x$height" \
    -F "$foreground" \
    -B "$background" \
    -f "$font" \
    -f "$icons" \
    -n "$name" &

# ensure proper fullscreen
# TODO : use xdo -m when available
until xdo id -a "$name" > /dev/null; do
    sleep .1s
done
xdo lower -a "$name"

wait
